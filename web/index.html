<!DOCTYPE html>
<html><body><script>
    (function() {
      let flutterScriptPromise = null;
      function loadFlutterEngine() {
        if (!flutterScriptPromise) {
          flutterScriptPromise = new Promise((resolve) => {
            const script = document.createElement('script');
            script.src = './flutter.js'; // Percorso relativo
            script.defer = true;
            document.head.appendChild(script);
            script.onload = () => {
              window._flutter.loader.loadEntrypoint().then(engineInitializer => resolve(engineInitializer));
            };
          });
        }
        return flutterScriptPromise;
      }

      class FlutterMessageComponent extends HTMLElement {
        static _count = 0;

        constructor() {
          super();
          this.attachShadow({ mode: 'open' });
          this._controller = null; // Il nostro controller Dart
        }

        async connectedCallback() {
          const hostId = `flutter-host-${FlutterMessageComponent._count++}`;
          const hostElement = document.createElement('div');
          hostElement.id = hostId;
          hostElement.style.width = '100%';
          hostElement.style.height = '100%';
          this.shadowRoot.appendChild(hostElement);

          const engineInitializer = await loadFlutterEngine();
          const appRunner = await engineInitializer.initializeEngine({ hostElement: hostElement });

          // La nostra funzione Dart main.dart::main() viene compilata in JS come `main_dart.main`.
          // La libreria `msal_js` fa qualcosa di simile.
          // Dobbiamo trovare il nome corretto. Con l'approccio di `js_interop` è più facile.

          // Chiamiamo il nostro punto di ingresso Dart, passando l'ID dell'host
          // Assumiamo che il nostro entrypoint sia `main_dart.mainForComponent`
          // NOTA: Trovare il nome esatto della funzione compilata può essere complicato.
          // Un approccio più semplice è usare una funzione globale di "registrazione"
          window.registerFlutterInstance = (controller) => {
            this._controller = controller;
            this._updateMessage(); // Invia il messaggio iniziale
          };

          await appRunner.runApp();
        }

        attributeChangedCallback(name, oldValue, newValue) {
          if (name === 'message' && oldValue !== newValue) {
            this._updateMessage();
          }
        }

        static get observedAttributes() { return ['message']; }

        _updateMessage() {
          if (this._controller) {
            const message = this.getAttribute('message') || '';
            this._controller.message = message;
          }
        }
      }
      customElements.define('flutter-message-component', FlutterMessageComponent);
    })();
</script></body></html>